<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 漫画下载器 · fancxxy's blog</title><meta name="description" content="漫画下载器 - fancxxy"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://fancxxy.github.io/atom.xml" title="fancxxy's blog"><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="fancxxy's blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/logo.gif" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="/tags/" target="_self">TAGS</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/fancxxy" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://www.weibo.com/fancxxy" target="_blank">WEIBO</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">漫画下载器</h1><div class="post-info">2018-04-17<a class="tag-title" href="/tags/Python/">#Python</a></div><div class="post-content"><p>为了解决自己喜欢看漫画却没有好的观看体验的问题，用Python写了工具comicd，配合iOS上的iComics体验有了质的提升，不用再去忍受各种web和APP的弹窗推送。</p>
<p>comicd完全使用Python3标准库编写，未使用第三方模块，这篇文章是回顾我开发的过程，记录当时的一些思路，涉及到的知识点有基本Python语法、多线程、HTTP协议等。</p>
<p>comicd可以以命令的方式运行，也可以以包的形式导入作为应用代码的接口，目前支持的站点有腾讯漫画、网易漫画、动漫之家、动漫屋，想要自定义添加新的站点，只需要继承抽象接口类并实现所有必要的方法。</p>
<span id="more"></span>


<img src="/2018/04/17/comic-downloader/comicd.gif" class="">

<p>复杂的程序都是由简单组件组成的，首先介绍程序内的几个功能类。</p>
<h2 id="请求"><a href="#请求" class="headerlink" title="请求"></a>请求</h2><p>下载资源需要向资源站点发送HTTP请求，使用标准库的urllib包创建一个<code>Request</code>类对象，模拟发送请求。在<code>Request</code>类对象中创建默认的请求首部，包括内容协商、支持的压缩格式以及浏览器标示。<code>request</code>方法可以指定额外的请求首部，比如Host或者Referer，函数返回值是HTTP响应的主体部分。<code>urllib.parse.quote</code>方法对URL进行编码处理，除了指定的字符之外全部编码成加utf-8格式，用于网络传输。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> urllib.error</span><br><span class="line"><span class="keyword">from</span> gzip <span class="keyword">import</span> decompress</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Request</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    default = &#123;</span><br><span class="line">        <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Accept-Encoding&#x27;</span>: <span class="string">&#x27;gzip, deflate&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Accept-Language&#x27;</span>: <span class="string">&#x27;zh-CN,en-US;q=0.5&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Connection&#x27;</span>: <span class="string">&#x27;keep-alive&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:54.0) Gecko/20100101 Firefox/54.0&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">request</span>(<span class="params">self, url, data=<span class="literal">None</span>, headers=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">if</span> headers:</span><br><span class="line">            headers = &#123;**self.default, **headers&#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            headers = self.default</span><br><span class="line">        url = urllib.parse.quote(url, safe=<span class="string">&#x27;%/:?=&amp;[]&#x27;</span>)</span><br><span class="line">        req = urllib.request.Request(url, data=data, headers=headers)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> urllib.request.urlopen(req) <span class="keyword">as</span> res:</span><br><span class="line">                <span class="keyword">if</span> res.getheader(<span class="string">&#x27;Content-Encoding&#x27;</span>) == <span class="string">&#x27;gzip&#x27;</span>:</span><br><span class="line">                    res = decompress(res.read())</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    res = res.read()</span><br><span class="line">                <span class="keyword">return</span> res</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p><code>request</code>方法已经获取到了HTTP响应内容，根据获取到的内容不同处理方式也不相同。<code>content</code>方法对响应解码返回str。<code>page</code>方法用来保存网页到指定文件，如果没有指定文件名默认保存在当前目录下，正则表达式<code>r&#39;(?&lt;=&lt;title&gt;).*?(?=&lt;/title&gt;)&#39;)</code>获取网页的标题，正向前视断言<code>(?=exp)</code>和正向后视断言<code>(?&lt;=exp)</code>同时使用可以获取任意节点的内容。对于图像数据，直接保存原始的二进制数据，调用<code>binary</code>方法存储图像文件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Request</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">content</span>(<span class="params">self, url, data=<span class="literal">None</span>, headers=<span class="literal">None</span></span>):</span><br><span class="line">        response = self.request(url, data, headers)</span><br><span class="line">        <span class="keyword">if</span> response:</span><br><span class="line">            <span class="keyword">return</span> response.decode(<span class="string">&#x27;utf-8&#x27;</span>, <span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">page</span>(<span class="params">self, url, file=<span class="literal">None</span>, data=<span class="literal">None</span>, headers=<span class="literal">None</span></span>):</span><br><span class="line">        response = self.request(url, data, headers).decode(<span class="string">&#x27;utf-8&#x27;</span>, <span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> response:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> file:</span><br><span class="line">            pattern = <span class="built_in">compile</span>(<span class="string">r&#x27;(?&lt;=&lt;title&gt;).*?(?=&lt;/title&gt;)&#x27;</span>)</span><br><span class="line">            result = pattern.search(response)</span><br><span class="line">            <span class="keyword">if</span> result:</span><br><span class="line">                file = result.group(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                file = <span class="string">&#x27;comic_&#x27;</span> + strftime(<span class="string">&#x27;%Y%m%d_%H%M%S&#x27;</span>, localtime(time()))</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file + <span class="string">&#x27;.html&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(response.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">binary</span>(<span class="params">self, url, data=<span class="literal">None</span>, headers=<span class="literal">None</span></span>):</span><br><span class="line">        response = self.request(url, data=data, headers=headers)</span><br><span class="line">        <span class="keyword">if</span> response:</span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">b&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h2><p>日志可以用来调试程序，定位问题，甚至可以分析用户习惯。Python标准库的<code>logging</code>模块提供记录日志的功能，利用<code>logging</code>模块封装一下自己的日志类，把它设置成单例模式，先创建一个单例类对象<code>Singleton</code>，让<code>Log</code>类继承获得单例属性。Python中创建单例模式的方式有多种，这里采用的方法是用<code>__new__</code>方法控制实例对象的创建。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(cls, <span class="string">&#x27;_instance&#x27;</span>):</span><br><span class="line">            cls._instance = <span class="built_in">super</span>(Singleton, cls).__new__(cls, *args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> cls._instance</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Log</span>(<span class="title class_ inherited__">Singleton</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(self, <span class="string">&#x27;logger&#x27;</span>):</span><br><span class="line">            self.logger = logging.getLogger(<span class="string">&#x27;comicd&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            handler = logging.StreamHandler(stream=stderr)</span><br><span class="line"></span><br><span class="line">            fmt = <span class="string">&#x27;%(message)s&#x27;</span></span><br><span class="line">            formatter = logging.Formatter(fmt, datefmt=<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">            handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">            self.logger.setLevel(logging.INFO)</span><br><span class="line">            handler.setLevel(logging.INFO)</span><br><span class="line"></span><br><span class="line">            self.logger.addHandler(handler)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">info</span>(<span class="params">self, message</span>):</span><br><span class="line">        self.logger.info(message)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">warning</span>(<span class="params">self, message</span>):</span><br><span class="line">        self.logger.warning(message)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">error</span>(<span class="params">self, message</span>):</span><br><span class="line">        self.logger.error(message)</span><br></pre></td></tr></table></figure>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>配置文件通过<code>Config</code>类定义，提供可修改的配置有下载主目录，线程数量，失败请求的重试次数。<code>@property</code>装饰器可以把方法变成属性，添加参数判断。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Config</span>(<span class="title class_ inherited__">Singleton</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, home=<span class="string">&#x27;~/Comics&#x27;</span>, comic=<span class="number">1</span>, chapter=<span class="number">1</span>, image=<span class="number">5</span>, repeat=<span class="number">3</span>, mode=<span class="string">&#x27;crawler&#x27;</span></span>):</span><br><span class="line">        self._home = expanduser(home)</span><br><span class="line"></span><br><span class="line">        self.log = join(self._home, <span class="string">&#x27;.comicd.log&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self.serialize = join(self._home, <span class="string">&#x27;.comicd.dat&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self._threads = [comic, chapter, image]</span><br><span class="line"></span><br><span class="line">        self.repeat = repeat</span><br><span class="line"></span><br><span class="line">        self.mode = mode</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">home</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._home</span><br><span class="line"></span><br><span class="line"><span class="meta">    @home.setter</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">home</span>(<span class="params">self, value</span>):</span><br><span class="line">        self._home = expanduser(value)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">threads</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._threads</span><br><span class="line"></span><br><span class="line"><span class="meta">    @threads.setter</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">threads</span>(<span class="params">self, value</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value, <span class="built_in">list</span>) <span class="keyword">or</span> <span class="built_in">len</span>(value) != <span class="number">3</span>:</span><br><span class="line">            value = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">5</span>]</span><br><span class="line">        self._threads = value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;Config object home=\&#x27;&#123;&#125;\&#x27; threads=&#123;&#123;comic:&#123;&#125;, chapter:&#123;&#125;, image:&#123;&#125;&#125;&#125; repeat=&#123;&#125; mode=&#123;&#125;&gt;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">            self._home, self.threads[<span class="number">0</span>], self.threads[<span class="number">1</span>], self.threads[<span class="number">2</span>], self.repeat, self.mode)</span><br><span class="line"></span><br><span class="line">    __str__ = __repr__</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">config = Config()</span><br></pre></td></tr></table></figure>

<p><code>config</code>实例对象作为暴露给外部的接口，为了让它更像是类对象，实现<code>__call__</code>方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Config</span>(<span class="title class_ inherited__">Singleton</span>):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, home=<span class="string">&#x27;~/Comics&#x27;</span>, comic=<span class="number">1</span>, chapter=<span class="number">1</span>, image=<span class="number">5</span>, repeat=<span class="number">3</span>, mode=<span class="string">&#x27;crawler&#x27;</span></span>):</span><br><span class="line">        self.__init__(home, comic, chapter, image, repeat, mode)</span><br><span class="line">        <span class="keyword">return</span> self</span><br></pre></td></tr></table></figure>

<h2 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h2><p>有了以上三个功能类之后，我们就可以来写业务了。创建<code>interface</code>包用来实现漫画站点的解析功能，每个网站的解析都用一个类对象表示并放在单独的模块中。定义<code>Web</code>基类来规定接口，所有的网站解析类都要继承<code>Web</code>类对象，以保证<code>Comic</code>和<code>Chapter</code>模型(后面会介绍)调用解析接口不会报错。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Web</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    _pattern = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self._request = Request()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">url</span>(<span class="params">self, url</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self._pattern[<span class="string">&#x27;comic_url&#x27;</span>].match(url).group()</span><br><span class="line">        <span class="keyword">except</span> AttributeError:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">curl</span>(<span class="params">self, url</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self._pattern[<span class="string">&#x27;chapter_url&#x27;</span>].match(url).group()</span><br><span class="line">        <span class="keyword">except</span> AttributeError:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>为了方便扩展，解析模块以文件为单位动态加载。每个网站的解析类都放在同名的文件中，例如腾讯漫画的解析类名是<code>Tencent</code>，存放在<code>tencent.py</code>文件中。实现动态加载的过程是这样的，先遍历interface包获取所有模块的文件名，对应解析类的类名就是文件名首字母大写，根据Python的反射特性获取类名以及<code>host</code>属性，动态创建解析实例对象，存放在以<code>host</code>为key字典中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Interface</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self._interface = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        path = dirname(__file__)</span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> listdir(path):</span><br><span class="line">            name, extension = splitext(file)</span><br><span class="line">            <span class="keyword">if</span> name == <span class="string">&#x27;__init__&#x27;</span> <span class="keyword">or</span> extension != <span class="string">&#x27;.py&#x27;</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            mod = import_module(<span class="string">&#x27;comicd.interface.&#x27;</span> + name)</span><br><span class="line">            cls = <span class="built_in">getattr</span>(mod, name.capitalize())</span><br><span class="line">            host = <span class="built_in">getattr</span>(cls, <span class="string">&#x27;host&#x27;</span>)</span><br><span class="line">            self._interface[host[<span class="number">0</span>]] = cls()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="keyword">return</span> self._interface[key]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">lists</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> &#123;cls.name <span class="keyword">for</span> cls <span class="keyword">in</span> self._interface.values()&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @lists.setter</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">lists</span>(<span class="params">self, value</span>):</span><br><span class="line">        <span class="keyword">raise</span> AttributeError(<span class="string">&#x27;lists is not a writable attribute&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>至于解析类需要实现的方法要根据<code>Comic</code>和<code>Chapter</code>这两个模型来确定。</p>
<h2 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h2><p><code>Comic</code>和<code>Chapter</code>模型分别表示漫画和章节，这两个类对象也是暴露给外部代码调用的接口，模型对象通过调用内部<code>interface</code>接口来解析并获取漫画的数据内容。<code>Comic</code>和<code>Chapter</code>都继承自基类<code>Model</code>，<code>Model</code>中实现两个基本的类方法。<code>find</code>方法根据正则表达式来获取输入的的url地址的netloc，在interface字典中查找对应的解析实例对象。<code>support</code>方法列出所有支持的网站列表。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> comicd.interface <span class="keyword">import</span> interface</span><br><span class="line"><span class="keyword">from</span> comicd.config <span class="keyword">import</span> config</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Model</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.instance = <span class="literal">None</span></span><br><span class="line">        self.repeat = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find</span>(<span class="params">cls, url</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pattern = <span class="built_in">compile</span>(<span class="string">r&#x27;https?://([^/]+?)/&#x27;</span>)</span><br><span class="line">            host = pattern.search(url).group(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> interface[host]</span><br><span class="line">        <span class="keyword">except</span> (AttributeError, KeyError):</span><br><span class="line">            <span class="keyword">raise</span> ComicdError(<span class="string">&#x27;comicd does not support this website&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">support</span>(<span class="params">cls</span>):</span><br><span class="line">        <span class="keyword">return</span> interface.lists</span><br></pre></td></tr></table></figure>

<p><code>Comic</code>对象包含漫画的所有内容，可以使用多线程来加快内容的获取。虽然CPython有GIL锁的限制，但是网络请求属于IO密集型的任务，所以使用多线程不受GIL锁影响。为了不让主线程在创建实例的时候等待响应而阻塞，初始化的时候只绑定不需要发送请求就能获取到的属性，而在之后需要访问其他属性时再发送请求并解析响应。</p>
<p>所以我利用描述器的特性创建一个<code>LazyProperty</code>装饰器来延迟初始化，原理就是用装饰器把类方法装饰成描述器，在第一次访问某个方法时，在漫画实例的<code>__dict__</code>查找，没有找到再到漫画类的<code>__dict__</code>中查找，找到之后调用方法并把返回的结果放到实例对象的<code>__dict__</code>中，之后再访问该描述器时就能直接从实例对象的<code>__dict__</code>获取结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LazyProperty</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, func</span>):</span><br><span class="line">        self.func = func</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__get__</span>(<span class="params">self, instance, <span class="built_in">type</span>=<span class="literal">None</span></span>):</span><br><span class="line">        val = self.func(instance)</span><br><span class="line">        <span class="built_in">setattr</span>(instance, self.func.__name__, val)</span><br><span class="line">        <span class="keyword">return</span> val</span><br></pre></td></tr></table></figure>

<p>初始化时只绑定了两个实例属性，<code>self.instance</code>是解析漫画内容的实例对象，<code>self.url</code>是漫画的主页地址，在工作线程中可以调用<code>init</code>方法来强制获取所有属性的值。<code>data</code>属性存放HTTP的响应主体，<code>title</code>、<code>chapters</code>和<code>summary</code>分别是漫画标题，章节列表和简介，它们的获取方式都是通过把<code>data</code>属性传给<code>interface</code>接口，由<code>interface</code>接口解析返回结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> comicd.utils <span class="keyword">import</span> LazyProperty <span class="keyword">as</span> Lazy</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Comic</span>(<span class="title class_ inherited__">Model</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, url</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        self.instance = Model.find(url)</span><br><span class="line">        self.url = self._check(url)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> self.title == <span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> self.summary == <span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> self.chapters == []:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @Lazy</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">data</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.instance.comic(self.url)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @Lazy</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">title</span>(<span class="params">self</span>):</span><br><span class="line">        title = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> self.data:</span><br><span class="line">            title = self.instance.title(self.data)</span><br><span class="line">        <span class="keyword">return</span> title</span><br><span class="line"></span><br><span class="line"><span class="meta">    @Lazy</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">chapters</span>(<span class="params">self</span>):</span><br><span class="line">        chapters = []</span><br><span class="line">        <span class="keyword">if</span> self.data:</span><br><span class="line">            chapters = self.instance.chapters(self.data)</span><br><span class="line">        <span class="keyword">return</span> chapters</span><br><span class="line"></span><br><span class="line"><span class="meta">    @Lazy</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">summary</span>(<span class="params">self</span>):</span><br><span class="line">        summary = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> self.data:</span><br><span class="line">            summary = self.instance.summary(self.data)</span><br><span class="line">        <span class="keyword">return</span> summary.strip(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">from</span> comicd.crawler <span class="keyword">import</span> Crawler</span><br><span class="line">        crawler = Crawler()</span><br><span class="line">        crawler.put(<span class="string">&#x27;Comic&#x27;</span>, self)</span><br><span class="line">        crawler.crawl()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check</span>(<span class="params">self, raw_url</span>):</span><br><span class="line">        url = self.instance.url(raw_url)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> url:</span><br><span class="line">            <span class="keyword">raise</span> ComicdError(<span class="string">&#x27;comic url is incorrect&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> url</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;Comic object interface=\&#x27;&#123;&#125;\&#x27; title=\&#x27;&#123;&#125;\&#x27;&gt;&#x27;</span>.<span class="built_in">format</span>(self.instance.name, self.title)</span><br><span class="line"></span><br><span class="line">    __str__ = __repr__</span><br></pre></td></tr></table></figure>

<p><code>Chapter</code>类的处理方式和<code>Comic</code>类似，用来获取章节的信息，两个类都提供了<code>download</code>方法来下载资源，<code>Chapter</code>类解析可以获得图片资源的真实地址，另外创建内部使用的模型<code>Image</code>来作为图片对象，<code>Image</code>类对象不对外公开，每个实例表示一张图片资源，<code>Chapter</code>实例对象解析出图片地址后批量初始化<code>Image</code>实例放到资源队列中，由其他工作线程下载对应图片。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Image</span>(<span class="title class_ inherited__">Model</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, url, instance, filename, referer, title=<span class="literal">None</span>, ctitle=<span class="literal">None</span>, page=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.url = url</span><br><span class="line">        self.instance = instance</span><br><span class="line">        self.filename = filename</span><br><span class="line">        self.referer = referer</span><br><span class="line"></span><br><span class="line">        self.title = title</span><br><span class="line">        self.ctitle = ctitle</span><br><span class="line">        self.page = page</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">self</span>):</span><br><span class="line">        complete = <span class="literal">False</span></span><br><span class="line">        binary = self.instance.image(self.url, self.referer)</span><br><span class="line">        <span class="keyword">if</span> binary:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(self.filename, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> image:</span><br><span class="line">                image.write(binary)</span><br><span class="line">            complete = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> complete</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;Image object interface=\&#x27;&#123;&#125;\&#x27; title=\&#x27;&#123;&#125;\&#x27;, &#x27;</span> \</span><br><span class="line">               <span class="string">&#x27;ctitle=\&#x27;&#123;&#125;\&#x27;, page=\&#x27;&#123;&#125;\&#x27;&gt;&#x27;</span>.<span class="built_in">format</span>(self.instance.name, self.title, self.ctitle, self.page)</span><br><span class="line"></span><br><span class="line">    __str__ = __repr__</span><br></pre></td></tr></table></figure>

<h2 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h2><p>comicd本质就是一个爬虫，从输入漫画的主页地址开始，解析出漫画的所有章节地址，每获得一个章节地址就去解析该章节包含的所有图片的链接，通过链接下载资源。</p>
<p>为了完成上述功能，需要创建一个<code>Crawler</code>类，类三个队列分别用来存放<code>Comic</code>、<code>Chapter</code>以及<code>Image</code>实例对象，另外还需要初始化多个线程来处理上述队列中的实例对象。<code>initialize</code>方法接收一个URL列表，私有方法<code>_parse</code>根据URL的格式来返回字符串model，字符串的可选值是<code>Comic</code>和<code>Chapter</code>，<code>&#39;&#123;&#125;(url)&#39;.format(model)</code>生成字符串表达式，再通过<code>eval()</code>来构造实例对象，<code>self._queue[model].put()</code>把实例对象放到队列中。<code>crawl</code>方法创建并启动线程，<code>CrawlerThread</code>是一个线程类，重写<code>run</code>方法定义线程任务，<code>name</code>属性用来区分线程的工作类型。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CrawlerThread</span>(<span class="title class_ inherited__">Thread</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, handler, crawler, name</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(name=name)</span><br><span class="line">        self.crawler = crawler</span><br><span class="line">        self.handler = handler</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> interrupt:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                task = self.crawler.get(self.name)</span><br><span class="line">                <span class="keyword">if</span> self.handler(task):</span><br><span class="line">                    self.crawler.put(self.name, task)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.crawler.exception(self.name, task)</span><br><span class="line">                self.crawler.finish(self.name)</span><br><span class="line">            <span class="keyword">except</span> Empty:</span><br><span class="line">                <span class="keyword">if</span> self.crawler.complete(self.name):</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Crawler</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self._queue = &#123;<span class="string">&#x27;Comic&#x27;</span>: Queue(), <span class="string">&#x27;Chapter&#x27;</span>: Queue(), <span class="string">&#x27;Image&#x27;</span>: Queue()&#125;</span><br><span class="line"></span><br><span class="line">        self._lock = Lock()</span><br><span class="line"></span><br><span class="line">        self._config = config</span><br><span class="line"></span><br><span class="line">        self._log = Log()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> config.mode == <span class="string">&#x27;crawler&#x27;</span>:</span><br><span class="line">            signal(SIGINT, Crawler.sig_handler)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">self, urls</span>):</span><br><span class="line">        <span class="keyword">for</span> u <span class="keyword">in</span> urls:</span><br><span class="line">            model, url = self._parse(u)</span><br><span class="line">            <span class="keyword">if</span> model:</span><br><span class="line">                self._queue[model].put(<span class="built_in">eval</span>(<span class="string">&#x27;&#123;&#125;(url)&#x27;</span>.<span class="built_in">format</span>(model)))</span><br><span class="line"></span><br><span class="line">        self.crawl()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">crawl</span>(<span class="params">self, comic_thread=<span class="literal">None</span>, chapter_thread=<span class="literal">None</span>, image_thread=<span class="literal">None</span></span>):</span><br><span class="line"></span><br><span class="line">        comic_threads = [CrawlerThread(handler=Comic.init, crawler=self, name=<span class="string">&#x27;Comic&#x27;</span>)</span><br><span class="line">                         <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(comic_thread <span class="keyword">if</span> comic_thread <span class="keyword">else</span> self._config.threads[<span class="number">0</span>])]</span><br><span class="line"></span><br><span class="line">        chapter_threads = [CrawlerThread(handler=Chapter.init, crawler=self, name=<span class="string">&#x27;Chapter&#x27;</span>)</span><br><span class="line">                           <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(chapter_thread <span class="keyword">if</span> chapter_thread <span class="keyword">else</span> self._config.threads[<span class="number">1</span>])]</span><br><span class="line"></span><br><span class="line">        image_threads = [CrawlerThread(handler=Image.download, crawler=self, name=<span class="string">&#x27;Image&#x27;</span>)</span><br><span class="line">                         <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(image_thread <span class="keyword">if</span> image_thread <span class="keyword">else</span> self._config.threads[<span class="number">2</span>])]</span><br><span class="line"></span><br><span class="line">        [t.start() <span class="keyword">for</span> t <span class="keyword">in</span> comic_threads]</span><br><span class="line">        <span class="keyword">if</span> config.mode == <span class="string">&#x27;crawler&#x27;</span>:</span><br><span class="line">            sleep(<span class="number">1</span>)</span><br><span class="line">        [t.start() <span class="keyword">for</span> t <span class="keyword">in</span> chapter_threads]</span><br><span class="line">        <span class="keyword">if</span> config.mode == <span class="string">&#x27;crawler&#x27;</span>:</span><br><span class="line">            sleep(<span class="number">1</span>)</span><br><span class="line">        [t.start() <span class="keyword">for</span> t <span class="keyword">in</span> image_threads]</span><br><span class="line"></span><br><span class="line">        [t.join() <span class="keyword">for</span> t <span class="keyword">in</span> (*comic_threads, *chapter_threads, *image_threads)]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> interrupt:</span><br><span class="line">            self.serialize()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_parse</span>(<span class="params">self, raw_url</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            instance = Model.find(raw_url)</span><br><span class="line">            url = instance.curl(raw_url)</span><br><span class="line">            <span class="keyword">if</span> url:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;Chapter&#x27;</span>, url</span><br><span class="line">            url = instance.url(raw_url)</span><br><span class="line">            <span class="keyword">if</span> url:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;Comic&#x27;</span>, url</span><br><span class="line">        <span class="keyword">except</span> ComicdError:</span><br><span class="line">            self._log.warning(<span class="string">&#x27;cannot handle url &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(raw_url))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>, raw_url</span><br><span class="line">            </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sig_handler</span>(<span class="params">signum, frame</span>):</span><br><span class="line">        <span class="keyword">global</span> interrupt</span><br><span class="line">        interrupt = <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<p><code>Crawler</code>实例在初始化时设定了捕捉<code>SIGINT</code>信号，如果检测到Ctrl+C信号，则调用<code>sig_handler</code>方法把<code>interrupt</code>设置成True，在<code>crawl</code>方法中如果发现线程不是自动结束而是被<code>interrupt</code>标志给终止时，调用<code>serialize</code>方法把三个队列中未处理的实例序列化到本地，对应的实现了一个反序列化的方法<code>deserialize</code>可以快速恢复到上一次终止的状态，这样就实现了断点续传的功能了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Crawler</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">serialize</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(self._config.serialize, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            dump((self._queue[<span class="string">&#x27;Comic&#x27;</span>].queue, self._queue[<span class="string">&#x27;Chapter&#x27;</span>].queue, self._queue[<span class="string">&#x27;Image&#x27;</span>].queue), f)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">deserialize</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> exists(self._config.serialize):</span><br><span class="line">            self._log.error(<span class="string">&#x27;no serialize file found&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(self._config.serialize, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            q1, q2, q3 = load(f)</span><br><span class="line">            [self._queue[<span class="string">&#x27;Comic&#x27;</span>].put(item) <span class="keyword">for</span> item <span class="keyword">in</span> <span class="built_in">list</span>(q1)]</span><br><span class="line">            [self._queue[<span class="string">&#x27;Chapter&#x27;</span>].put(item) <span class="keyword">for</span> item <span class="keyword">in</span> <span class="built_in">list</span>(q2)]</span><br><span class="line">            [self._queue[<span class="string">&#x27;Image&#x27;</span>].put(item) <span class="keyword">for</span> item <span class="keyword">in</span> <span class="built_in">list</span>(q3)]</span><br><span class="line"></span><br><span class="line">        self.crawl()</span><br></pre></td></tr></table></figure>

<p>线程类的<code>run</code>方法定义了线程功能，主要逻辑是从队列获取元素，处理完成之后放到下一级队列中，如果队列为空需要判断自身是否满足退出条件，满足则退出线程否则进行下一轮循环。不同功能的线程处理方式略有不同，通过创建线程时指定的线程名作为判断线程功能的标记。每个实例对象都有一个<code>repeat</code>属性用来标记实例被处理的次数，如果实例处理失败了，在未超过预设定的重复次数之前会被重新放到队列中等待下次处理，一定程度上排除网络原因带来的干扰。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Crawler</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">put</span>(<span class="params">self, name, task</span>):</span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">&#x27;Comic&#x27;</span>:</span><br><span class="line">            <span class="keyword">for</span> chapter <span class="keyword">in</span> task.chapters:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    self._queue[<span class="string">&#x27;Chapter&#x27;</span>].put(Chapter(chapter[<span class="number">1</span>]))</span><br><span class="line">                <span class="keyword">except</span> ComicdError:</span><br><span class="line">                    self._log.warning(<span class="string">&#x27;cannot handle url &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(chapter[<span class="number">1</span>]))</span><br><span class="line">        <span class="keyword">elif</span> name == <span class="string">&#x27;Chapter&#x27;</span>:</span><br><span class="line">            f = Folder(self._config.home, task.title, task.ctitle)</span><br><span class="line">            self._queue[<span class="string">&#x27;Image&#x27;</span>].put(f)</span><br><span class="line">            <span class="keyword">for</span> image <span class="keyword">in</span> task.images:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    self._queue[<span class="string">&#x27;Image&#x27;</span>].put(Image(image[<span class="number">1</span>], task.instance,</span><br><span class="line">                                                   join(f.path, image[<span class="number">0</span>]),</span><br><span class="line">                                                   task.url, task.title,</span><br><span class="line">                                                   task.ctitle, image[<span class="number">0</span>]))</span><br><span class="line">                <span class="keyword">except</span> ComicdError:</span><br><span class="line">                    self._log.warning(<span class="string">&#x27;cannot handle url &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(image[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">&#x27;Comic&#x27;</span> <span class="keyword">or</span> name == <span class="string">&#x27;Chapter&#x27;</span>:</span><br><span class="line">            task = self._queue[name].get(timeout=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># name == &#x27;Image&#x27;</span></span><br><span class="line">            <span class="keyword">with</span> self._lock:</span><br><span class="line">                task = self._queue[name].get(timeout=<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">while</span> <span class="built_in">isinstance</span>(task, Folder):</span><br><span class="line">                    task.create()</span><br><span class="line">                    self._log.info(<span class="string">&#x27; &lt;&#x27;</span> + task.title + <span class="string">&#x27;&gt; &#x27;</span> + task.ctitle)</span><br><span class="line">                    task = self._queue[name].get(timeout=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> task</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">finish</span>(<span class="params">self, name</span>):</span><br><span class="line">        self._queue[name].task_done()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">complete</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">&#x27;Comic&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> name == <span class="string">&#x27;Chapter&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> self._queue[<span class="string">&#x27;Comic&#x27;</span>].empty()</span><br><span class="line">        <span class="keyword">elif</span> name == <span class="string">&#x27;Image&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> self._queue[<span class="string">&#x27;Comic&#x27;</span>].empty() <span class="keyword">and</span> self._queue[<span class="string">&#x27;Chapter&#x27;</span>].empty()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">exception</span>(<span class="params">self, name, task</span>):</span><br><span class="line">        <span class="keyword">if</span> task.repeat &gt;= self._config.repeat:</span><br><span class="line">            self._log.warning(<span class="string">&#x27;handle task &#123;&#125; failed&#x27;</span>.<span class="built_in">format</span>(task))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            task.repeat += <span class="number">1</span></span><br><span class="line">            self._queue[name].put(task)</span><br></pre></td></tr></table></figure>

<h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><p>最后一步用上述功能类来组装一个脚本程序完成漫画下载的功能。标准库的<code>argparse</code>包可以很方便的给脚本添加参数，我这里设置了三个参数，<code>—url</code>参数是一个URL的列表，包含了所有需要下载的某个漫画或某个章节的地址列表，<code>—resume</code>参数恢复上一次终止的任务，<code>—file</code>参数指定文件名，从文件中读取地址列表。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">comicd</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> exists(config.home):</span><br><span class="line">        makedirs(config.home)</span><br><span class="line"></span><br><span class="line">    parser = ArgumentParser(description=<span class="string">&#x27;Comic Download Tool&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-u&#x27;</span>, <span class="string">&#x27;--url&#x27;</span>, nargs=<span class="string">&#x27;+&#x27;</span>, dest=<span class="string">&#x27;urls&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;urls of comics&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-r&#x27;</span>, <span class="string">&#x27;--resume&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>, dest=<span class="string">&#x27;resume&#x27;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;resume last crawl task&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;--file&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, dest=<span class="string">&#x27;file&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;crawl from file&#x27;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    urls = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> comicd.crawler <span class="keyword">import</span> Crawler</span><br><span class="line">    crawler = Crawler()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> args.resume:</span><br><span class="line">        crawler.deserialize()</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> args.urls:</span><br><span class="line">        urls = args.urls</span><br><span class="line">    <span class="keyword">elif</span> args.file:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(args.file, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            urls = [u <span class="keyword">for</span> u <span class="keyword">in</span> f.readlines()]</span><br><span class="line"></span><br><span class="line">    crawler.initialize(urls)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    comicd()</span><br></pre></td></tr></table></figure>

<h2 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h2><p>comicd提供了<code>Comic</code>, <code>Chapter</code>, <code>Config</code>和<code>ComicdError</code>作为外部使用的编程接口，全部写入到__init__.py的<code>__all__</code>变量。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> comicd.model <span class="keyword">import</span> Comic, Chapter</span><br><span class="line"><span class="keyword">from</span> comicd.config <span class="keyword">import</span> config <span class="keyword">as</span> Config</span><br><span class="line"><span class="keyword">from</span> comicd.error <span class="keyword">import</span> ComicdError</span><br><span class="line"></span><br><span class="line">__all__ = [</span><br><span class="line">    <span class="string">&#x27;Comic&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Chapter&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Config&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ComicdError&#x27;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>setup.py填写基本的配置信息，指定脚本名为<code>comic</code>，配置好依赖，当然在这个项目里requirements.txt内容是空的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> setuptools <span class="keyword">import</span> setup, find_packages</span><br><span class="line"></span><br><span class="line">requirements = <span class="built_in">open</span>(<span class="string">&#x27;requirements.txt&#x27;</span>).readlines()</span><br><span class="line"></span><br><span class="line">setup(</span><br><span class="line">    name=<span class="string">&#x27;comicd&#x27;</span>,</span><br><span class="line">    version=<span class="string">&#x27;0.0.1&#x27;</span>,</span><br><span class="line">    author=<span class="string">&#x27;fancxxy&#x27;</span>,</span><br><span class="line">    author_email=<span class="string">&#x27;fancxxy@gmail.com&#x27;</span>,</span><br><span class="line">    url=<span class="string">&#x27;https://github.com/fancxxy/comicd&#x27;</span>,</span><br><span class="line">    description=<span class="string">&#x27;comic download tool&#x27;</span>,</span><br><span class="line">    scripts=[<span class="string">&#x27;comic&#x27;</span>],</span><br><span class="line">    license=<span class="string">&#x27;MIT&#x27;</span>,</span><br><span class="line">    classifiers=[],</span><br><span class="line">    packages=find_packages(exclude=(<span class="string">&#x27;tests&#x27;</span>,)),</span><br><span class="line">    install_requires=requirements</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2018/06/13/comic-website/">PREV</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'fancxxy';
var disqus_identifier = '2018/04/17/comic-downloader/';
var disqus_title = '漫画下载器';
var disqus_url = 'https://fancxxy.github.io/2018/04/17/comic-downloader/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script><div class="copyright"><p>© 2018 - 2022 <a href="https://fancxxy.github.io">fancxxy</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>