<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 给comicd写的前端网站 · fancxxy's blog</title><meta name="description" content="给comicd写的前端网站 - fancxxy"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://fancxxy.github.io/atom.xml" title="fancxxy's blog"><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="fancxxy's blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/logo.gif" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="/tags/" target="_self">TAGS</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/fancxxy" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://www.weibo.com/fancxxy" target="_blank">WEIBO</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">给comicd写的前端网站</h1><div class="post-info">2018-06-13<a class="tag-title" href="/tags/Python/">#Python</a></div><div class="post-content"><p>之前写了一个下载漫画的命令行工具comicd，确实可以轻松获取漫画资源了，但是并没有想象中的便捷。首先每次获取资源都需要执行下载命令，对于完结漫画还可以接受，一次下载一劳永逸，但对于长期连载的漫画就显得很不方便，其次不能随时随地在手机上查看，需要通过电脑下载传到手机上，所以在其基础上实现了一个web应用<a target="_blank" rel="noopener" href="https://github.com/fancxxy/ComicWeb">ComicWeb</a>，可以添加想要追的漫画，定时任务自动刷新资源。</p>
<span id="more"></span>

<h2 id="网站"><a href="#网站" class="headerlink" title="网站"></a>网站</h2><p>ComicWeb是一个订阅和观看漫画的网站，支持主流的几个漫画资源网站，项目仅供个人学习，请勿用于商业盈利。项目中使用的主要框架和组件是Flask+Bootstrap+MySQL，后端的漫画爬取功能参阅<a target="_blank" rel="noopener" href="https://github.com/fancxxy/comicd">fancxxy&#x2F;comicd</a>。</p>
<img src="/2018/06/13/comic-website/comic-list.jpg" class="">
<img src="/2018/06/13/comic-website/chapter-list.jpg" class="">
<img src="/2018/06/13/comic-website/comic-picture.jpg" class="">

<h2 id="程序"><a href="#程序" class="headerlink" title="程序"></a>程序</h2><p>ComicWeb的后端功能是用Flask实现的，Flask是一个用Python编写的轻量级Web框架，扩展能力强，程序的工程目录大致如下，requirements.txt记录所有依赖的扩展，config.py是工程的配置文件，在初始化Flask程序实例的时候通过参数传递过去，web.py是启动脚本，在环境变量中设置启动脚本的值<code>FLASK_APP=web.py</code>，app&#x2F;templates是模板文件的存放目录，app&#x2F;static存放静态文件，app&#x2F;main是蓝本目录，程序的主要路由功能都定义在该蓝本目录下，app&#x2F;models.py定义数据库表结构，app&#x2F;auth是登录认证的蓝本，assist包含定时更新任务。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">|-ComicWeb</span><br><span class="line">  |-app/</span><br><span class="line">    |-templates/</span><br><span class="line">    |-static/</span><br><span class="line">    |-main/</span><br><span class="line">      |-__init__.py</span><br><span class="line">      |-errors.py</span><br><span class="line">      |-forms.py</span><br><span class="line">      |-views.py</span><br><span class="line">    |-auth/</span><br><span class="line">      |-__init__.py</span><br><span class="line">      |-forms.py</span><br><span class="line">      |-views.py</span><br><span class="line">    |-__init__.py</span><br><span class="line">    |-models.py</span><br><span class="line">  |-assist</span><br><span class="line">    |-__init__.py</span><br><span class="line">    |-update.py</span><br><span class="line">  |-requirements.txt</span><br><span class="line">  |-config.py</span><br><span class="line">  |-web.py </span><br></pre></td></tr></table></figure>

<h3 id="主表结构"><a href="#主表结构" class="headerlink" title="主表结构"></a>主表结构</h3><p>Flask程序一般都配合数据库抽象框架SQLAlchemy一起使用，可以使用面向对象的操作来处理数据库指令。首先需要安装Flask得扩展<code>flask-sqlalchemy</code>，包装了SQLAlchemy的操作，对于MySQL的连接串格式是<code>mysql://username:password@hostname/database</code>，同时表结构为了获得抽象能力，定义时需要继承<code>db.Model</code>类，使用<code>__tablename__</code>来确定表名，表字段通过<code>db.Column</code>创建。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    email = db.Column(db.String(<span class="number">64</span>), unique=<span class="literal">True</span>, index=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">64</span>), unique=<span class="literal">True</span>, index=<span class="literal">True</span>)</span><br><span class="line">    password_hash = db.Column(db.String(<span class="number">128</span>))</span><br></pre></td></tr></table></figure>

<p>ComicWeb网站的两个主要的对象分别是用户和漫画，用户登录后可以订阅多个漫画资源，某个漫画资源同时也可以被多个用户订阅，所以对于用户和漫画的关系是Many to Many，根据SQLAlchemy的文档Many to Many的关系需要在两个类之间建立一个关联表来体现订阅关系，关联表不需要抽象，直接用<code>db.table</code>创建。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">subscribers = db.Table(<span class="string">&#x27;subscribers&#x27;</span>,</span><br><span class="line">                        db.Column(<span class="string">&#x27;user_id&#x27;</span>, db.Integer, db.ForeignKey(<span class="string">&#x27;users.id&#x27;</span>), primary_key=<span class="literal">True</span>),</span><br><span class="line">                        db.Column(<span class="string">&#x27;comic_id&#x27;</span>, db.Integer, db.ForeignKey(<span class="string">&#x27;comics.id&#x27;</span>), primary_key=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>这种创建方式的表不能被抽象，意味着不能从<code>subscribers</code>表获取额外有用信息，如果想要存储订阅时间就需要抽象<code>subscribers</code>表，这里额外记录了用户对于某个漫画的订阅日期和该漫画的观看进度。关系的两端<code>User</code>和<code>Comic</code>分别通过<code>db.relationship</code>来指定对端关系，方法的第一额参数是关系对端的模型名字，<code>backref</code>参数用来在对端模型中创建一个反向引用，<code>lazy=&#39;dynamic&#39;</code>表明<code>comcis</code>的加载方式是调用<code>query</code>方法时加载记录，<code>cascade</code>参数的值由逗号分隔，把对象添加到会话后会把关联的所有对象都添加到会话，同时删除对象时会把关联的所有孤儿记录都删除掉。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Subscriber</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;subscribers&#x27;</span></span><br><span class="line">    user_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;users.id&#x27;</span>), primary_key=<span class="literal">True</span>)</span><br><span class="line">    comic_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;comics.id&#x27;</span>), primary_key=<span class="literal">True</span>)</span><br><span class="line">    subscribe_date = db.Column(db.DateTime(), default=datetime.utcnow)</span><br><span class="line">    last_chapter_id = db.Column(db.Integer)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    comics = db.relationship(<span class="string">&#x27;Subscriber&#x27;</span>, backref=db.backref(<span class="string">&#x27;user&#x27;</span>, lazy=<span class="string">&#x27;joined&#x27;</span>), lazy=<span class="string">&#x27;dynamic&#x27;</span>,</span><br><span class="line">                             cascade=<span class="string">&#x27;all, delete-orphan&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Comic</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;comics&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    url = db.Column(db.String(<span class="number">256</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line">    title = db.Column(db.String(<span class="number">128</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    interface = db.Column(db.String(<span class="number">32</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    cover = db.Column(db.String(<span class="number">256</span>))</span><br><span class="line">    summary = db.Column(db.Text())</span><br><span class="line">    newest_chapter_id = db.Column(db.Integer)</span><br><span class="line">    newest_chapter_title = db.Column(db.String(<span class="number">128</span>))</span><br><span class="line">    update_time = db.Column(db.DateTime(), default=<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    users = db.relationship(<span class="string">&#x27;Subscriber&#x27;</span>, backref=db.backref(<span class="string">&#x27;comic&#x27;</span>, lazy=<span class="string">&#x27;joined&#x27;</span>), lazy=<span class="string">&#x27;dynamic&#x27;</span>,</span><br><span class="line">                            cascade=<span class="string">&#x27;all, delete-orphan&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>有了上述关系模型就可以很方便的查询某个用户订阅的漫画列表，以及某个漫画的所有订阅用户。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>user = User.query.filter_by(<span class="built_in">id</span>=<span class="number">1</span>).first()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>user</span><br><span class="line">&lt;User fxx&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[item.comic <span class="keyword">for</span> item <span class="keyword">in</span> user.comics]</span><br><span class="line">[&lt;Comic 航海王 腾讯漫画&gt;, &lt;Comic 银魂 腾讯漫画&gt;, &lt;Comic 死神/境·界 腾讯漫画&gt;, &lt;Comic 火影忍者 腾讯漫画&gt;, &lt;Comic 龙珠 腾讯漫画&gt;]</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>comic = Comic.query.filter_by(<span class="built_in">id</span>=<span class="number">1</span>).first()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>comic</span><br><span class="line">&lt;Comic 航海王 腾讯漫画&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[item.user <span class="keyword">for</span> item <span class="keyword">in</span> comic.users]</span><br><span class="line">[&lt;User fxx&gt;, &lt;User fancxxy&gt;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="登录认证"><a href="#登录认证" class="headerlink" title="登录认证"></a>登录认证</h3><p>登录以及管理会话的功能需要用到的扩展列表有</p>
<ul>
<li>flask-login: 管理已登录的用户会话</li>
<li>werkzeug: 计算密码散列值并在每次输入密码时进行核对</li>
<li>itsdangerous: 生成核对加密令牌</li>
</ul>
<p>创建登录页面的表单，需要安装扩展<code>flask_wtf</code>，表单类都继承自<code>FlaskForm</code>类，表单中的项都是wtforms模块中的类实例，<code>validatiors</code>参数是一个验证函数组成的列表，<code>render_kw</code>是一个属性字典，在渲染<code>input</code>标签时添加<code>placeholder=&quot;输入电子邮件&quot;</code>属性。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> StringField, PasswordField, BooleanField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired, Length, Email</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LoginForm</span>(<span class="title class_ inherited__">FlaskForm</span>):</span><br><span class="line">    email = StringField(<span class="string">&#x27;邮件地址:&#x27;</span>, validators=[DataRequired(), Length(<span class="number">1</span>, <span class="number">64</span>), Email()], render_kw=&#123;<span class="string">&#x27;placeholder&#x27;</span>: <span class="string">&#x27;输入邮件地址&#x27;</span>&#125;)</span><br><span class="line">    password = PasswordField(<span class="string">&#x27;密码:&#x27;</span>, validators=[DataRequired()], render_kw=&#123;<span class="string">&#x27;placeholder&#x27;</span>: <span class="string">&#x27;输入密码&#x27;</span>&#125;)</span><br><span class="line">    remember_me = BooleanField(<span class="string">&#x27;保持登录&#x27;</span>)</span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;登录&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>密码肯定不能明文存储，也不让直接读取，使用<code>@property</code>装饰物改变<code>password</code>变量的读写属性，使用<code>Werkzeug</code>的<code>security</code>模块来处理密码散列值，<code>generate_password_hash</code>方法计算输入密码的散列值，<code>check_password_hash</code>方法比较输入的密码和存储在数据库中的散列值是否匹配，<code>flask-login</code>提供了多个方法校验用户是否登录，是否激活，本地用户模型想要使用这些方法就需要继承<code>UserMixin</code>类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model, UserMixin):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">password</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">raise</span> AttributeError(<span class="string">&#x27;password is not a readable attribute&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @password.setter</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">password</span>(<span class="params">self, password</span>):</span><br><span class="line">        self.password_hash = generate_password_hash(password)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">verify_password</span>(<span class="params">self, password</span>):</span><br><span class="line">        <span class="keyword">return</span> check_password_hash(self.password_hash, password)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>定义登录和登出的视图函数，一旦密码验证成功后调用<code>flask-login</code>的<code>login_user</code>方法在会话中把用户标记为已登录，<code>logout_user</code>方法让用户登出。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@auth.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    form = LoginForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        user = User.query.filter_by(email=form.email.data).first()</span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> user.verify_password(form.password.data):</span><br><span class="line">            login_user(user, form.remember_me.data)</span><br><span class="line">            <span class="keyword">return</span> redirect(request.args.get(<span class="string">&#x27;next&#x27;</span>) <span class="keyword">or</span> url_for(<span class="string">&#x27;main.index&#x27;</span>))</span><br><span class="line">        flash(<span class="string">&#x27;错误的邮件地址或者密码&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>, form=form)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@auth.route(<span class="params"><span class="string">&#x27;/logout&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    logout_user()</span><br><span class="line">    flash(<span class="string">&#x27;您已经退出&#x27;</span>, <span class="string">&#x27;info&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;main.index&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>前端框架Bootstrap通过<code>flask-bootstrap</code>扩展可以很方便的和Flask的模版系统集成在一起，该扩展提供<code>quick_form</code>宏方法渲染表单对象。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;base.html&quot; %&#125;</span><br><span class="line">&#123;% import &quot;bootstrap/wtf.html&quot; as wtf %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;Comic - Login&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block page_content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-lg-12&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;page-header&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h1</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-4&quot;</span>&gt;</span></span><br><span class="line">            &#123;&#123; wtf.quick_form(form) &#125;&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p>登录页面截图</p>
<h3 id="功能路由"><a href="#功能路由" class="headerlink" title="功能路由"></a>功能路由</h3><p>主页面有一个订阅新漫画的输入框，下面列出该用户订阅的所有漫画列表，每个漫画资源都展示了标题、封面、更新时间和来源。<br>让用户订阅漫画的逻辑其实就是向<code>subscribers</code>表插入一条数据，在<code>User</code>模型中添加<code>subscribe</code>方法实现这个功能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model, UserMixin):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">subscribe</span>(<span class="params">self, comic</span>):</span><br><span class="line">        <span class="keyword">if</span> self.comics.filter_by(comic_id=comic.<span class="built_in">id</span>).first() <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        s = Subscriber(user=self, comic=comic)</span><br><span class="line">        db.session.add(s)</span><br></pre></td></tr></table></figure>

<p>不同网站提供的漫画封面大小不一样，为了风格统一，写了一个方法裁剪封面大小，把高度和宽度的比例设置成了4:3，需要用到Python的图像处理库<code>PIL</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">crop_cover</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">with</span> Image.<span class="built_in">open</span>(filename) <span class="keyword">as</span> im:</span><br><span class="line">        width, height = im.size</span><br><span class="line"></span><br><span class="line">        <span class="comment"># width divide height must be equal 3/4</span></span><br><span class="line">        <span class="keyword">if</span> width / height &gt; <span class="number">0.75</span>:</span><br><span class="line">            w = width - height * <span class="number">0.75</span></span><br><span class="line">            im.crop((w // <span class="number">2</span>, <span class="number">0</span>, width - w // <span class="number">2</span>, height)).save(filename)</span><br><span class="line">            im.crop((<span class="number">0</span>, <span class="number">10</span>, <span class="number">300</span>, <span class="number">400</span>)).save()</span><br><span class="line">        <span class="keyword">elif</span> width / height &lt; <span class="number">0.75</span>:</span><br><span class="line">            h = height - width // <span class="number">0.75</span></span><br><span class="line">            im.crop((<span class="number">0</span>, h // <span class="number">2</span>, width, height - h // <span class="number">2</span>)).save(filename)</span><br></pre></td></tr></table></figure>

<p>章节作为资源对象也需要被抽象化，<code>Comic</code>跟<code>Chapter</code>的关系是one to many，需要在<code>Comic</code>模型中指明关系。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Chapter</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;chapters&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    url = db.Column(db.String(<span class="number">256</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line">    chapter_no = db.Column(db.Integer)</span><br><span class="line">    title = db.Column(db.String(<span class="number">128</span>))</span><br><span class="line">    interface = db.Column(db.String(<span class="number">32</span>))</span><br><span class="line">    comic_title = db.Column(db.String(<span class="number">128</span>))</span><br><span class="line">    comic_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;comics.id&#x27;</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    update_time = db.Column(db.DateTime(), default=datetime.utcnow)</span><br><span class="line">    path = db.Column(db.String(<span class="number">256</span>), default=<span class="literal">None</span>)</span><br><span class="line">    __table_args__ = (db.UniqueConstraint(<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;comic_title&#x27;</span>, <span class="string">&#x27;interface&#x27;</span>, name=<span class="string">&#x27;uc_title_comic_title_interface&#x27;</span>),</span><br><span class="line">                      db.UniqueConstraint(<span class="string">&#x27;chapter_no&#x27;</span>, <span class="string">&#x27;comic_id&#x27;</span>, name=<span class="string">&#x27;uc_no_id&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;Chapter &#123;&#125; &#123;&#125; &#123;&#125;&gt;&#x27;</span>.<span class="built_in">format</span>(self.comic_title, self.title, self.interface)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Comic</span>(db.Model):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    chapters = db.relationship(<span class="string">&#x27;Chapter&#x27;</span>, backref=<span class="string">&#x27;comic&#x27;</span>, lazy=<span class="string">&#x27;dynamic&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>订阅漫画表单需要校验漫画来源是否支持，<code>ComicWeb</code>获取漫画资源使用的是<code>comicd</code>的接口，<code>comicd</code>提供的<code>Comic.find</code>静态方法可以校验提交的url地址是否支持，不支持会抛出<code>ComicdError</code>的异常。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> comicd <span class="keyword">import</span> Comic, ComicdError</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SubscribeForm</span>(<span class="title class_ inherited__">FlaskForm</span>):</span><br><span class="line">    url = StringField(<span class="string">&#x27;Comic URL:&#x27;</span>, validators=[DataRequired(), URL()], render_kw=&#123;<span class="string">&#x27;placeholder&#x27;</span>: <span class="string">&#x27;输入漫画网址&#x27;</span>&#125;)</span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;订阅&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_url</span>(<span class="params">self, field</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            Comic.find(field.data)</span><br><span class="line">        <span class="keyword">except</span> ComicdError:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;只支持 &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27; &#x27;</span>.join(<span class="built_in">list</span>(Comic.support()))))</span><br></pre></td></tr></table></figure>

<p>主页面视图函数的逻辑是这样的，首先验证一下提交的表单数据，如果提交的漫画数据已经存在在数据库中，则直接让用户订阅该漫画，如果漫画还没收录就需要使用<code>comicd</code>提供的接口去对应网站请求漫画数据，向<code>comics</code>表插入漫画数据，下载漫画封面，让用户订阅漫画，向<code>chapters</code>表插入所有章节的数据，业务处理完成后重定向到主页面，通过分页查询返回数据，最后渲染页面。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@main.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    form = SubscribeForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        comic = Comic.query.filter_by(url=form.url.data).first()</span><br><span class="line">        <span class="keyword">if</span> comic:</span><br><span class="line">            current_user.subscribe(comic)</span><br><span class="line">            flash(<span class="string">&#x27;订阅成功&#x27;</span>, <span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;main.index&#x27;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            c = cc(form.url.data)</span><br><span class="line">            <span class="keyword">if</span> c.init():</span><br><span class="line">                <span class="built_in">hash</span> = md5((c.instance.name + c.title).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()</span><br><span class="line">                comic = Comic(url=c.url, title=c.title, interface=c.instance.name, cover=<span class="built_in">hash</span> + <span class="string">&#x27;.jpg&#x27;</span>,</span><br><span class="line">                              summary=c.summary)</span><br><span class="line">                r, f = c.download_cover(<span class="string">&#x27;app/static/covers&#x27;</span>, comic.cover)</span><br><span class="line">                <span class="keyword">if</span> r:</span><br><span class="line">                    crop_cover(f)</span><br><span class="line">                current_user.subscribe(comic)</span><br><span class="line">                db.session.add(comic)</span><br><span class="line">                db.session.commit()</span><br><span class="line">                index = <span class="number">1</span></span><br><span class="line">                <span class="keyword">for</span> title, url <span class="keyword">in</span> c.chapters:</span><br><span class="line">                    chapter = Chapter(title=title, comic_title=comic.title, interface=comic.interface, url=url,</span><br><span class="line">                                      comic_id=comic.<span class="built_in">id</span>, chapter_no=index)</span><br><span class="line">                    db.session.add(chapter)</span><br><span class="line">                    index += <span class="number">1</span></span><br><span class="line">                db.session.commit()</span><br><span class="line">                chapter = Chapter.query.filter_by(comic_id=comic.<span class="built_in">id</span>).order_by(db.desc(Chapter.<span class="built_in">id</span>)).first()</span><br><span class="line">                comic.newest_chapter_id, comic.newest_chapter_title = chapter.<span class="built_in">id</span>, chapter.title</span><br><span class="line">                db.session.add(comic)</span><br><span class="line">                db.session.commit()</span><br><span class="line">                flash(<span class="string">&#x27;订阅成功&#x27;</span>, <span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;main.index&#x27;</span>))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                flash(<span class="string">&#x27;订阅失败&#x27;</span>, <span class="string">&#x27;danger&#x27;</span>)</span><br><span class="line">    page = request.args.get(<span class="string">&#x27;page&#x27;</span>, <span class="number">1</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">    pagination = current_user.comics.paginate(page, per_page=current_app.config[<span class="string">&#x27;COMICS_PER_PAGE&#x27;</span>], error_out=<span class="literal">False</span>)</span><br><span class="line">    comics = [item.comic <span class="keyword">for</span> item <span class="keyword">in</span> pagination.items]</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, comics=comics, pagination=pagination, form=form)</span><br></pre></td></tr></table></figure>

<p>表单框不能使用<code>form.quick_form()</code>直接渲染，手写一个输入框，<code>form.hidden_tag()</code>是为了隐藏CSRF信息。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-form&quot;</span>&gt;</span></span><br><span class="line">    &#123;&#123; form.hidden_tag() &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group&quot;</span>&gt;</span></span><br><span class="line">        &#123;&#123; form.url(class=&quot;form-control input-sm&quot;) &#125;&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;input-group-btn&quot;</span>&gt;</span></span><br><span class="line">            &#123;&#123; form.submit(class=&quot;btn btn-primary btn-sm&quot;) &#125;&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加订阅的逻辑是向<code>subscribers</code>表插入数据，那么取消订阅的逻辑就是删除这条数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@main.route(<span class="params"><span class="string">&#x27;/unsubscribe/&lt;id&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unsubscribe</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    subscriber = Subscriber.query.filter_by(user_id=current_user.<span class="built_in">id</span>, comic_id=<span class="built_in">id</span>).first()</span><br><span class="line">    <span class="keyword">if</span> subscriber:</span><br><span class="line">        db.session.delete(subscriber)</span><br><span class="line">    flash(<span class="string">&#x27;取消订阅&#x27;</span>, <span class="string">&#x27;info&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;main.index&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>取消按钮放在封面图的左下角，当鼠标移动过去背景设置为黑色半透明，移开之后背景设置为透明，<code>:hover</code>选择器可以控制鼠标指针浮动的效果。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.shownn</span> <span class="selector-class">.unsubscribe</span> &#123;</span><br><span class="line">    <span class="comment">/* */</span></span><br><span class="line">    <span class="attribute">background</span>: transparent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.shownn</span><span class="selector-pseudo">:hover</span> <span class="selector-class">.unsubscribe</span> &#123;</span><br><span class="line">    <span class="comment">/* */</span></span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, .<span class="number">50</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;shownn&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;unsubscribe&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;main.unsubscribe&#x27;, id=comic.id) &#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;取消订阅&quot;</span>&gt;</span>取消订阅<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>漫画主页的路由是<code>/comics/&lt;id&gt;</code>，这个页面展示了更详细的漫画信息、观看进度以及章节标题，观看进度保存在了<code>subscribers</code>表中，需要用<code>user_id</code>和<code>comic_id</code>去表里查询数据，<code>pagination(page, per_page=20, error_out=False)</code>方法由<code>flask-sqlalchemy</code>提供，方法返回一个<code>Pagination</code>分页对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@main.route(<span class="params"><span class="string">&#x27;/comics/&lt;id&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">comic</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    comic = Comic.query.get_or_404(<span class="built_in">id</span>)</span><br><span class="line">    page = request.args.get(<span class="string">&#x27;page&#x27;</span>, <span class="number">1</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">    pagination = comic.chapters.order_by(db.desc(Chapter.<span class="built_in">id</span>)).paginate(page,</span><br><span class="line">                                                                       per_page=current_app.config[<span class="string">&#x27;CHAPTERS_PER_PAGE&#x27;</span>],</span><br><span class="line">                                                                       error_out=<span class="literal">False</span>)</span><br><span class="line">    chapters = pagination.items</span><br><span class="line">    last_chapter = Chapter.query.filter_by(<span class="built_in">id</span>=Subscriber.query.filter_by(user_id=current_user.<span class="built_in">id</span>,</span><br><span class="line">                                                                         comic_id=<span class="built_in">id</span>).first().last_chapter_id).first()</span><br><span class="line">    newest_chapter = Chapter.query.filter_by(<span class="built_in">id</span>=comic.newest_chapter_id).first()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;comic.html&#x27;</span>, comic=comic, chapters=chapters, pagination=pagination,</span><br><span class="line">                           last_chapter=last_chapter, newest_chapter=newest_chapter)</span><br></pre></td></tr></table></figure>

<p><code>Pagination</code>分页对象提供<code>iter_pages</code>方法返回一个迭代器，存储的是分页导航显示的页数列表，在flasky的示例代码中就用这个迭代器创建了一个分页导航，这里我直接拿来用了。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;% macro pagination_widget(pagination, endpoint) %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;pagination&quot;</span>&gt;</span></span><br><span class="line">        &lt;li&#123;% if not pagination.has_prev %&#125; class=&quot;disabled&quot;&#123;% endif %&#125;&gt;</span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;% if pagination.has_prev %&#125;&#123;&#123; url_for(endpoint, page=pagination.prev_num, **kwargs) &#125;&#125;&#123;% else %&#125;#&#123;% endif %&#125;&quot;</span>&gt;</span></span><br><span class="line">                <span class="symbol">&amp;laquo;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% for p in pagination.iter_pages(left_edge=1, left_current=1, right_current=3, right_edge=1) %&#125;</span><br><span class="line">            &#123;% if p %&#125;</span><br><span class="line">                &#123;% if p == pagination.page %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;active&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url_for(endpoint, page = p, **kwargs) &#125;&#125;&quot;</span>&gt;</span>&#123;&#123; p &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% else %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url_for(endpoint, page = p, **kwargs) &#125;&#125;&quot;</span>&gt;</span>&#123;&#123; p &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">            &#123;% else %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;disabled&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span><span class="symbol">&amp;hellip;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">        &lt;li&#123;% if not pagination.has_next %&#125; class=&quot;disabled&quot;&#123;% endif %&#125;&gt;</span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;% if pagination.has_next %&#125;&#123;&#123; url_for(endpoint, page=pagination.next_num, **kwargs) &#125;&#125;&#123;% else %&#125;#&#123;% endif %&#125;&quot;</span>&gt;</span></span><br><span class="line">                <span class="symbol">&amp;raquo;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">&#123;% endmacro %&#125;</span><br></pre></td></tr></table></figure>

<p>图片也是资源，每张图片都有一条记录在<code>images</code>表里，以<code>comic_id</code>和<code>chapter_id</code>作为外键。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Image</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;images&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    comic_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;comics.id&#x27;</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    chapter_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;chapters.id&#x27;</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    image_no = db.Column(db.Integer, nullable=<span class="literal">False</span>)</span><br><span class="line">    path = db.Column(db.String(<span class="number">256</span>), nullable=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>图片资源的下载逻辑是这样的，有用户第一次请求该章节数据，去对应网站下载图片资源，把每张图片编号，编号和路径存储到<code>images</code>表中，之后再有用户请求该章节直接从<code>images</code>表给出查询结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@main.route(<span class="params"><span class="string">&#x27;/comics/&lt;id&gt;/&lt;no&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chapter</span>(<span class="params"><span class="built_in">id</span>, no</span>):</span><br><span class="line">    chapter = Chapter.query.filter_by(comic_id=<span class="built_in">id</span>, chapter_no=no).first()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> chapter.path:</span><br><span class="line">        c = cr(chapter.url)</span><br><span class="line">        <span class="keyword">if</span> c.init():</span><br><span class="line">            c.download()</span><br><span class="line">        count, chapter.path = <span class="number">1</span>, join(cg.home, quote(c.title), quote(c.ctitle))</span><br><span class="line">        <span class="keyword">if</span> exists(chapter.path):</span><br><span class="line">            files = <span class="built_in">sorted</span>([i <span class="keyword">for</span> i <span class="keyword">in</span> listdir(chapter.path) <span class="keyword">if</span> splitext(i)[<span class="number">1</span>] == <span class="string">&#x27;.jpg&#x27;</span>], key=<span class="keyword">lambda</span> x: <span class="built_in">int</span>(x[:-<span class="number">4</span>]))</span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">                image = Image(comic_id=<span class="built_in">id</span>, chapter_id=chapter.<span class="built_in">id</span>, image_no=count,</span><br><span class="line">                              path=join(quote(c.title), quote(c.ctitle), file))</span><br><span class="line">                db.session.add(image)</span><br><span class="line">                count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    subscriber = Subscriber.query.filter_by(user_id=current_user.<span class="built_in">id</span>, comic_id=chapter.comic_id).first()</span><br><span class="line">    subscriber.last_chapter_id = chapter.<span class="built_in">id</span></span><br><span class="line">    db.session.add(subscriber)</span><br><span class="line">    images = Image.query.filter_by(comic_id=<span class="built_in">id</span>, chapter_id=chapter.<span class="built_in">id</span>).order_by(Image.image_no).<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;chapter.html&#x27;</span>, chapter=chapter, images=images, previous=request.referrer)</span><br></pre></td></tr></table></figure>

<h3 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h3><p>长期连载的漫画会不定期更新，需要写一个方法来更新漫画章节目录，通过<code>comicd</code>的接口请求当前漫画的章节列表，判断列表末尾的数据和当前数据库的最新章节是否相同，如果不同说明有新章节更新了，在请求到的章节列表中找到当前数据库标记的最新章节数据的索引，索引后面的章节信息就是本次需要插到数据库的数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Comic</span>(db.Model):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self</span>):</span><br><span class="line">        c = cc(self.url)</span><br><span class="line">        <span class="keyword">if</span> c.init():</span><br><span class="line">            chapter = Chapter.query.filter_by(<span class="built_in">id</span>=self.newest_chapter_id).first()</span><br><span class="line">            <span class="keyword">if</span> chapter <span class="keyword">and</span> chapter.title != c.chapters[-<span class="number">1</span>][<span class="number">0</span>]:</span><br><span class="line">                new_chapters = c.chapters[c.chapters.index((chapter.title, chapter.url)) + <span class="number">1</span>:]</span><br><span class="line">                no = chapter.chapter_no + <span class="number">1</span></span><br><span class="line">                <span class="keyword">for</span> title, url <span class="keyword">in</span> new_chapters:</span><br><span class="line">                    chapter = Chapter(title=title, comic_title=self.title, interface=self.interface, url=url,</span><br><span class="line">                                      comic_id=self.<span class="built_in">id</span>, chapter_no=no)</span><br><span class="line">                    db.session.add(chapter)</span><br><span class="line">                    no += <span class="number">1</span></span><br><span class="line">                new_chapter = Chapter.query.filter_by(comic_id=self.<span class="built_in">id</span>).order_by(db.desc(Chapter.<span class="built_in">id</span>)).first()</span><br><span class="line">                self.newest_chapter_id, self.newest_chapter_title = new_chapter.<span class="built_in">id</span>, new_chapter.title</span><br><span class="line">                self.update_time = datetime.utcnow()</span><br><span class="line">                db.session.add(self)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;comic &#123;&#125; update at &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.title, datetime.utcnow().strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>在assist&#x2F;update.py文件中添加更新的方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">update_comics</span>():</span><br><span class="line">    <span class="keyword">with</span> db.app.app_context():</span><br><span class="line">        [comic.update() <span class="keyword">for</span> comic <span class="keyword">in</span> Comic.query.<span class="built_in">all</span>()]</span><br></pre></td></tr></table></figure>

<p>定时任务通过<code>flask-apscheduler</code>扩展实现，设置每隔一段时间调用上面的更新方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> assist.update <span class="keyword">import</span> update_comics</span><br><span class="line">    cron.add_job(<span class="built_in">id</span>=<span class="string">&#x27;update_comics&#x27;</span>, func=update_comics, trigger=<span class="string">&#x27;interval&#x27;</span>, hours=app.config[<span class="string">&#x27;UPDATE_HOURS&#x27;</span>])</span><br><span class="line">    cron.start()</span><br></pre></td></tr></table></figure>

<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p>最后一步是部署，一般使用的web服务器是uwsgi，通过uWSGI协议和Flask程序交换数据，外部使用nginx转发请求。</p>
<p>uwsgi的配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line"></span><br><span class="line"># uwsgi 启动时所使用的地址与端口</span><br><span class="line">socket = 127.0.0.1:8001 </span><br><span class="line"></span><br><span class="line"># 指向网站目录</span><br><span class="line">chdir = /home/fancxxy/Works/ComicWeb</span><br><span class="line"></span><br><span class="line"># python 启动程序文件</span><br><span class="line">wsgi-file = /home/fancxxy/Works/ComicWeb/web.py</span><br><span class="line"></span><br><span class="line"># python 程序内用以启动的 application 变量名</span><br><span class="line">callable = app</span><br><span class="line"></span><br><span class="line"># 处理器数</span><br><span class="line">processes = 4</span><br><span class="line"></span><br><span class="line"># 线程数</span><br><span class="line">threads = 2</span><br><span class="line"></span><br><span class="line">#状态检测地址</span><br><span class="line">stats = 127.0.0.1:9191</span><br></pre></td></tr></table></figure>

<p>nginx的配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    include uwsgi_params;</span><br><span class="line">    uwsgi_pass 127.0.0.1:8001;</span><br><span class="line">    uwsgi_param UWSGI_PYTHON /home/fancxxy/Works/ComicWeb/venv;</span><br><span class="line">    uwsgi_param UWSGI_CHDIR /home/fancxxy/Works/ComicWeb;</span><br><span class="line">    uwsgi_param UWSGI_SCRIPT web:app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>uwsgi通过systemd启动，给uwsgi写了一个启动脚本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=uWSGI script by fancxxy</span><br><span class="line">After=syslog.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/home/fancxxy/Works/ComicWeb/venv/bin/uwsgi --ini /home/fancxxy/Works/ComicWeb/uwsgi.ini</span><br><span class="line">Restart=always</span><br><span class="line">KillSignal=SIGQUIT</span><br><span class="line">Type=notify</span><br><span class="line">StandardError=syslog</span><br><span class="line">NotifyAccess=all</span><br><span class="line">EnvironmentFile=/home/fancxxy/Works/ComicWeb/env.sh</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2018/06/22/comic-webiste-deploy-in-aliyun/">PREV</a><a class="next" href="/2018/04/17/comic-downloader/">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'fancxxy';
var disqus_identifier = '2018/06/13/comic-website/';
var disqus_title = '给comicd写的前端网站';
var disqus_url = 'https://fancxxy.github.io/2018/06/13/comic-website/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script><div class="copyright"><p>© 2018 - 2022 <a href="https://fancxxy.github.io">fancxxy</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>