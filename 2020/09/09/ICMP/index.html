<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> ICMP监控 · fancxxy's blog</title><meta name="description" content="ICMP监控 - fancxxy"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://fancxxy.github.io/atom.xml" title="fancxxy's blog"><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="fancxxy's blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/logo.gif" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="/tags/" target="_self">TAGS</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/fancxxy" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://www.weibo.com/fancxxy" target="_blank">WEIBO</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">ICMP监控</h1><div class="post-info">2020-09-09<a class="tag-title" href="/tags/Protocol/">#Protocol</a><a class="tag-title" href="/tags/Go/">#Go</a></div><div class="post-content"><p><code>ping</code>命令可以用来探测对端机器的网络连通状况以及网络延迟时间。当只有单台机器时可以用<code>ping</code>命令来探测，但如果有几千台机器就不合适了，所以我们利用<code>ping</code>命令的原理写了一个支持同时探测上千台机器网络连通性的程序。</p>
<span id="more"></span>

<h3 id="ICMP-Protocol"><a href="#ICMP-Protocol" class="headerlink" title="ICMP Protocol"></a>ICMP Protocol</h3><p>首先得了解ICMP协议，ICMP中文名是互联网控制报文协议，全称Internet Control Message Protocol，主要作用就是传输网络诊断信息。</p>
<p>ICMP报文分两类，分别是差错报文和询问报文，监控网络连通性用的是询问报文的Echo Request和Echo Reply，报文结构如下，传输时被封装在IP数据报中，但通常还是认为ICMP是网络层协议，目的机器收到Echo Request后会回应一个Echo Reply，内容和请求一模一样。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|     Type      |     Code      |          Checksum             |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|           Identifier          |        Sequence Number        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|     Data ...</span><br><span class="line">+-+-+-+-+-</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Type: 报文的类型，占用一个字节，ICMPv4的Echo Request和Echo Reply对应的Type分别是8和0，ICMPv6的对应值是128和129。</p>
</li>
<li><p>Code: 占用一个字节，请求和应答的Code都是0。</p>
</li>
<li><p>Checksum: 占用两个字节，校验和用来校验数据包的完整性。</p>
</li>
<li><p>Identifier: 占用两个字节，在ping命令中用的本进程的PID来赋值的，用来区分是哪个ping进程发出的请求。因为如果有多个ping进程同时运行，会从底层原始套接字读到对方进程的请求回包，根据这个字段判断如果不是自己发出的就丢弃。</p>
</li>
<li><p>Sequence Number: 占用两个字节，给每个发出的请求打上序列号，由于响应内容和请求内容一样所以也会包含相同序列号，用来关联请求和响应。</p>
</li>
</ul>
<h3 id="ICMP-package"><a href="#ICMP-package" class="headerlink" title="ICMP package"></a>ICMP package</h3><p><code>golang.org/x/net/icmp</code>包已经实现了ICMPv4和ICMPv6的基础功能，可以使用Echo相关的代码。</p>
<p><code>Message</code>是ICMP消息的结构体，其中<code>MessageBody</code>是一个接口类型，<code>Echo</code>实现了该接口。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Message <span class="keyword">struct</span> &#123;</span><br><span class="line">    Type     Type        <span class="comment">// type, either ipv4.ICMPType or ipv6.ICMPType</span></span><br><span class="line">    Code     <span class="type">int</span>         <span class="comment">// code</span></span><br><span class="line">    Checksum <span class="type">int</span>         <span class="comment">// checksum</span></span><br><span class="line">    Body     MessageBody <span class="comment">// body</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Echo <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID   <span class="type">int</span>    <span class="comment">// identifier</span></span><br><span class="line">    Seq  <span class="type">int</span>    <span class="comment">// sequence number</span></span><br><span class="line">    Data []<span class="type">byte</span> <span class="comment">// data</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ListenPacket</code>方法返回一个监听原始套接字的连接，通过这个连接可以发送和读取ICMP数据包（监听原始套接字需要root权限）。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ListenPacket</span><span class="params">(network, address <span class="type">string</span>)</span></span> (*PacketConn, <span class="type">error</span>)</span><br></pre></td></tr></table></figure>

<p>如果想要同时监控ICMPv4和ICMPv6，就需要初始化两个连接。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ListenPacket(<span class="string">&quot;ip4:icmp&quot;</span>, <span class="string">&quot;0.0.0.0&quot;</span>)</span><br><span class="line">ListenPacket(<span class="string">&quot;ip6:ipv6-icmp&quot;</span>, <span class="string">&quot;::&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>利用上面提到的连接和结构体实现一个最简单的发送Echo Request和接收Echo Reply的程序。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;net&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;golang.org/x/net/icmp&quot;</span></span><br><span class="line">	<span class="string">&quot;golang.org/x/net/ipv4&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">(conn *icmp.PacketConn, ip <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	dest, err := net.ResolveIPAddr(<span class="string">&quot;ip&quot;</span>, ip)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	msg := &amp;icmp.Message&#123;</span><br><span class="line">		Code: <span class="number">0</span>,</span><br><span class="line">		Type: ipv4.ICMPTypeEcho,</span><br><span class="line">		Body: &amp;icmp.Echo&#123;</span><br><span class="line">			ID:   os.Getpid(),</span><br><span class="line">			Seq:  <span class="number">2</span>,</span><br><span class="line">			Data: []<span class="type">byte</span>(<span class="string">&quot;hello icmp&quot;</span>),</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	wb, err := msg.Marshal(<span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_, err = conn.WriteTo(wb, dest)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">receive</span><span class="params">(conn *icmp.PacketConn)</span></span> (*icmp.Message, *icmp.Echo, <span class="type">error</span>) &#123;</span><br><span class="line">	buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">64</span>)</span><br><span class="line">	n, _, err := conn.ReadFrom(buf)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	msg, err := icmp.ParseMessage(<span class="number">1</span>, buf[:n])</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	body, ok := msg.Body.(*icmp.Echo)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, errors.New(<span class="string">&quot;cannot convert Message.Body to *icmp.Echo&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg, body, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	conn, err := icmp.ListenPacket(<span class="string">&quot;ip4:icmp&quot;</span>, <span class="string">&quot;0.0.0.0&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := send(conn, <span class="string">&quot;www.baidu.com&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> msg, echo, err := receive(conn); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;Type: %v, Code: %v, Checksum: %x\nIdentifier: %v, Sequence Number: %v\nData: %s\n&quot;</span>,</span><br><span class="line">			msg.Type, msg.Code, msg.Checksum, echo.ID, echo.Seq, echo.Data)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在root权限下运行的结果如下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Type: echo reply, Code: 0, Checksum: d779</span><br><span class="line">Identifier: 3518, Sequence Number: 2</span><br><span class="line">Data: hello icmp</span><br></pre></td></tr></table></figure>

<h3 id="Checksum"><a href="#Checksum" class="headerlink" title="Checksum"></a>Checksum</h3><p>Checksum的计算在<code>msg.Marshal</code>方法中调用。对每个16bit进行二进制反码求和，把最终结果的低16bit和高16bit继续求和，直到高16bit为0，返回结果。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Message)</span></span> Marshal(psh []<span class="type">byte</span>) ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    b := []<span class="type">byte</span>&#123;mtype, <span class="type">byte</span>(m.Code), <span class="number">0</span>, <span class="number">0</span>&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    s := checksum(b)</span><br><span class="line">    <span class="comment">// Place checksum back in header; using ^= avoids the</span></span><br><span class="line">    <span class="comment">// assumption the checksum bytes are zero.</span></span><br><span class="line">    b[<span class="built_in">len</span>(psh)+<span class="number">2</span>] ^= <span class="type">byte</span>(s)</span><br><span class="line">    b[<span class="built_in">len</span>(psh)+<span class="number">3</span>] ^= <span class="type">byte</span>(s &gt;&gt; <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> b[<span class="built_in">len</span>(psh):], <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checksum</span><span class="params">(b []<span class="type">byte</span>)</span></span> <span class="type">uint16</span> &#123;</span><br><span class="line">	csumcv := <span class="built_in">len</span>(b) - <span class="number">1</span> <span class="comment">// checksum coverage</span></span><br><span class="line">	s := <span class="type">uint32</span>(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; csumcv; i += <span class="number">2</span> &#123;</span><br><span class="line">		s += <span class="type">uint32</span>(b[i+<span class="number">1</span>])&lt;&lt;<span class="number">8</span> | <span class="type">uint32</span>(b[i])</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> csumcv&amp;<span class="number">1</span> == <span class="number">0</span> &#123;</span><br><span class="line">		s += <span class="type">uint32</span>(b[csumcv])</span><br><span class="line">	&#125;</span><br><span class="line">	s = s&gt;&gt;<span class="number">16</span> + s&amp;<span class="number">0xffff</span></span><br><span class="line">	s = s + s&gt;&gt;<span class="number">16</span></span><br><span class="line">	<span class="keyword">return</span> ^<span class="type">uint16</span>(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面的代码是模拟校验checksum的过程，x是待发送的ICMP数据包，先把checksum字段置0，也就是x[2]和x[3]置0。调用<code>checksum</code>方法计算结果，结果是16位整数，低位字节赋值给x[2]，高位字节赋值给x[3]。接收方收到数据后对完整的ICMP数据包调用<code>checksum</code>方法，最终计算结果是0，表示校验通过。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	x := []<span class="type">byte</span>&#123;<span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x04</span>, <span class="number">0x05</span>, <span class="number">0x06</span>, <span class="number">0x08</span>, <span class="number">0x09</span>&#125;</span><br><span class="line">	s := checksum(x)</span><br><span class="line">	x[<span class="number">2</span>] ^= <span class="type">byte</span>(s)</span><br><span class="line">	x[<span class="number">3</span>] ^= <span class="type">byte</span>(s &gt;&gt; <span class="number">8</span>)</span><br><span class="line">	fmt.Println(checksum(x))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Multiple-ICMP"><a href="#Multiple-ICMP" class="headerlink" title="Multiple ICMP"></a>Multiple ICMP</h3><p>支持同时对多个机器发送和接收ICMP数据包，发送和接收的方法肯定要分离，连接绑定原始套接字后，发送协程把Echo Request写入连接，接收协程从连接中读取并解析Echo Reply，接收的时间戳和发送的时间戳之差就是RTT值。</p>
<p>问题是接收之后如何通知发送协程，<code>Ping</code>是发送Echo Request的方法，每个Echo Request都有唯一序列号Sequence，可以给每个请求分配一个通道channel，和序列号关联。<code>receive</code>是接收Echo Reply的方法，根据解析出来的Echo Reply中的序列号找到通道，通知正在等待的发送协程。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Ping)</span></span> Ping(ip <span class="type">string</span>, timeout time.Duration) (time.Duration, <span class="type">error</span>) &#123;</span><br><span class="line">	ctx, cancel := context.WithDeadline(context.Background(), time.Now().Add(timeout))</span><br><span class="line">	<span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">	dest, err := net.ResolveIPAddr(<span class="string">&quot;ip&quot;</span>, ip)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		seq = <span class="type">int</span>(atomic.AddUint32(&amp;sequence, <span class="number">1</span>))</span><br><span class="line">		msg = icmp.Message&#123;</span><br><span class="line">			Code: <span class="number">0</span>,</span><br><span class="line">			Body: &amp;icmp.Echo&#123;</span><br><span class="line">				ID:   p.id,</span><br><span class="line">				Seq:  seq,</span><br><span class="line">				Data: p.payload,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;</span><br><span class="line">		conn *icmp.PacketConn</span><br><span class="line">		lock *sync.Mutex</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> dest.IP.To4() != <span class="literal">nil</span> &#123;</span><br><span class="line">		msg.Type = ipv4.ICMPTypeEcho</span><br><span class="line">		conn = p.conn4</span><br><span class="line">		lock = &amp;p.lock4</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		msg.Type = ipv6.ICMPTypeEchoRequest</span><br><span class="line">		conn = p.conn6</span><br><span class="line">		lock = &amp;p.lock6</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	bs, err := msg.Marshal(<span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	req := newRequest()</span><br><span class="line">	p.addReq(seq, req)</span><br><span class="line"></span><br><span class="line">	lock.Lock()</span><br><span class="line">	_, err = conn.WriteTo(bs, dest)</span><br><span class="line">	lock.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		req.<span class="built_in">close</span>()</span><br><span class="line">		p.delReq(seq)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> &lt;-req.wait:</span><br><span class="line">	<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">		p.delReq(seq)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">&quot;wait echo reply timeout&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> req.rtt()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Ping)</span></span> receive(proto <span class="type">int</span>, conn *icmp.PacketConn) &#123;</span><br><span class="line">	buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">1500</span>)</span><br><span class="line">	<span class="keyword">defer</span> p.wg.Done()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="comment">// conn.IPv4PacketConn().ReadFrom(buf)</span></span><br><span class="line">		<span class="comment">// conn.IPv6PacketConn().ReadFrom(buf)</span></span><br><span class="line">		n, _, err := conn.ReadFrom(buf)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> netErr, ok := err.(net.Error); !ok || !netErr.Temporary() &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		msg, err := icmp.ParseMessage(proto, buf[:n])</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> msg.Type &#123;</span><br><span class="line">		<span class="keyword">case</span> ipv4.ICMPTypeEchoReply, ipv6.ICMPTypeEchoReply:</span><br><span class="line">			echo, ok := msg.Body.(*icmp.Echo)</span><br><span class="line">			<span class="keyword">if</span> !ok || echo == <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> echo.ID != p.id &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			req := p.delReq(echo.Seq)</span><br><span class="line">			<span class="keyword">if</span> req != <span class="literal">nil</span> &#123;</span><br><span class="line">				req.<span class="built_in">close</span>()</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完整代码可以在<a target="_blank" rel="noopener" href="https://github.com/fancxxy/ping">GitHub</a>查看。</p>
<p>下面的例子演示同时ping多个地址的结果。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;sync&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/fancxxy/ping&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">rtt</span><span class="params">(p *ping.Ping, dest <span class="type">string</span>, timeout time.Duration, wg *sync.WaitGroup)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> wg.Done()</span><br><span class="line">	rtt, err := p.Ping(dest, timeout)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;ping %s, error %s\n&quot;</span>, dest, err)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;ping %s, rtt %.3f ms\n&quot;</span>, dest, <span class="type">float64</span>(rtt/time.Microsecond)/<span class="number">1000.0</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	p, err := ping.New(<span class="string">&quot;0.0.0.0&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		dests = []<span class="type">string</span>&#123;</span><br><span class="line">			<span class="string">&quot;www.baidu.com&quot;</span>,</span><br><span class="line">			<span class="string">&quot;www.weibo.com&quot;</span>,</span><br><span class="line">			<span class="string">&quot;www.qq.com&quot;</span>,</span><br><span class="line">			<span class="string">&quot;www.bilibili.com&quot;</span>,</span><br><span class="line">			<span class="string">&quot;www.zhihu.com&quot;</span>,</span><br><span class="line">			<span class="string">&quot;www.sina.com.cn&quot;</span>,</span><br><span class="line">			<span class="string">&quot;www.google.com&quot;</span>,</span><br><span class="line">		&#125;</span><br><span class="line">		timeout = time.Second * <span class="number">2</span></span><br><span class="line">		wg      sync.WaitGroup</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	wg.Add(<span class="built_in">len</span>(dests))</span><br><span class="line">	<span class="keyword">for</span> _, dest := <span class="keyword">range</span> dests &#123;</span><br><span class="line">		<span class="keyword">go</span> rtt(p, dest, timeout, &amp;wg)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果如下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ping www.baidu.com, rtt 25.514 ms</span><br><span class="line">ping www.sina.com.cn, rtt 26.012 ms</span><br><span class="line">ping www.weibo.com, rtt 53.461 ms</span><br><span class="line">ping www.zhihu.com, rtt 27.881 ms</span><br><span class="line">ping www.bilibili.com, rtt 29.017 ms</span><br><span class="line">ping www.qq.com, rtt 38.193 ms</span><br><span class="line">ping www.google.com, error wait echo reply timeout</span><br></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2020/11/20/go-https/">PREV</a><a class="next" href="/2020/07/20/cache-replacement-policies/">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'fancxxy';
var disqus_identifier = '2020/09/09/ICMP/';
var disqus_title = 'ICMP监控';
var disqus_url = 'https://fancxxy.github.io/2020/09/09/ICMP/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script><div class="copyright"><p>© 2018 - 2022 <a href="https://fancxxy.github.io">fancxxy</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>