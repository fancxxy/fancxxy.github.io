<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Go实现HTTPS服务器和客户端 · fancxxy's blog</title><meta name="description" content="Go实现HTTPS服务器和客户端 - fancxxy"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://fancxxy.github.io/atom.xml" title="fancxxy's blog"><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="fancxxy's blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/logo.gif" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="/tags/" target="_self">TAGS</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/fancxxy" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://www.weibo.com/fancxxy" target="_blank">WEIBO</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Go实现HTTPS服务器和客户端</h1><div class="post-info">2020-11-20<a class="tag-title" href="/tags/Protocol/">#Protocol</a><a class="tag-title" href="/tags/Go/">#Go</a></div><div class="post-content"><p>HTTPS全称HTTP over TLS，是利用TLS对HTTP数据加密的通信方式。TLS是一种安全协议，在网络多层模型中介于TCP层和Application层之间，在TCP三次握手完成后进行TLS握手，握手目的是获取证书验证身份，双方协商加密算法，生成对称加密密钥，验证加密是否成功。</p>
<span id="more"></span>

<h3 id="Wireshark抓包分析"><a href="#Wireshark抓包分析" class="headerlink" title="Wireshark抓包分析"></a>Wireshark抓包分析</h3><p>具体TLS握手分为以下几个步骤：</p>
<ol>
<li>Client Hello</li>
<li>Server Hello</li>
<li>Certificate</li>
<li>Server Key Exchange （可选）</li>
<li>Server Done</li>
<li>Client Key Exchange</li>
<li>Change Cipher Spec</li>
<li>Encrypted Handshake Message</li>
<li>New Session Ticker</li>
<li>Change Cipher Sepc</li>
<li>Encrypted Handshake Message</li>
</ol>
<p>通过抓取浏览器与<a href="blog.fancxxy.me">fancxxy’s blog</a>通信的TLS数据包来展示TLS握手过程。</p>
<h4 id="ClientHello"><a href="#ClientHello" class="headerlink" title="ClientHello"></a>ClientHello</h4><img src="client-hello.png">

<p>ClientHello是TLS握手的第一个包，客户端向服务端请求加密协商，包含自身支持的TLS协议版本，支持的加密套件列表，生成的随机数，用于生成对称加密密钥。</p>
<h4 id="ServerHello"><a href="#ServerHello" class="headerlink" title="ServerHello"></a>ServerHello</h4><img src="server-hello.png">

<p>服务端根据客户端提供的内容确定加密方式，此处是<code>TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</code>。</p>
<p><code>ECDHE_RSA</code>表示非对称加密算法是ECDH，此算法需要提供额外参数以及验证用的公钥，会在握手过程多一个步骤<code>Server key Exchange</code>，额外参数的签名算法是RSA。</p>
<p><code>AES_128_GCM</code>表示对称加密算法是AES，密钥长度128，分组使用GCM。</p>
<p><code>SHA256</code>表示计算消息流完整性的哈希算法。</p>
<p>同时服务端也生成了随机数，用于后续生成对称加密密钥。</p>
<h4 id="Certificate"><a href="#Certificate" class="headerlink" title="Certificate"></a>Certificate</h4><img src="certificate.png">

<p>加密算法协商之后，服务端发送自身数字证书以及签发该证书的证书链给客户端。客户端通过证书链找到根CA证书，根CA证书是内置在浏览器或操作系统中的，从根CA证书开始一级一级验证证书的合法性。</p>
<p>验证证书的过程，用证书中的公钥对密文解密，再用证书中的签名算法对证书内容签名，比较两者的结果是否相同。由于中间人无法获取CA机构的密钥，所以无法伪造证书做手脚。</p>
<h4 id="Server-Key-Exchange-Server-Hello-Done"><a href="#Server-Key-Exchange-Server-Hello-Done" class="headerlink" title="Server Key Exchange, Server Hello Done"></a>Server Key Exchange, Server Hello Done</h4><img src="server-hello-done.png">

<p><code>Server Key Exchange</code>发送ECDH的参数以及自己的公钥给客户端。</p>
<p><code>Server Hello Done</code>结束。</p>
<h4 id="Client-Key-Exchange-Change-Cipher-Spec-Encrypted-Handshake-Message"><a href="#Client-Key-Exchange-Change-Cipher-Spec-Encrypted-Handshake-Message" class="headerlink" title="Client Key Exchange, Change Cipher Spec, Encrypted Handshake Message"></a>Client Key Exchange, Change Cipher Spec, Encrypted Handshake Message</h4><img src="client-finished.png">

<p><code>Client Key Exchange</code>发送ECDH的参数以及自己的公钥给服务端。此时服务端和客户端都有了两个随机数、自己的私钥以及对方的公钥，可以各自在本地计算出相同的加密密钥，加密密钥就不用在网络传输了。</p>
<p><code>Change Cipher Spec</code>通知服务端后续数据使用对称加密算法加密。</p>
<p><code>Encrypted Handshake Message</code>客户端结束握手，发送整个流程中第一条密文数据给服务端解密。</p>
<h4 id="New-Session-Ticket-Change-Cipher-Spec-Encrypted-Handshake-Message"><a href="#New-Session-Ticket-Change-Cipher-Spec-Encrypted-Handshake-Message" class="headerlink" title="New Session Ticket, Change Cipher Spec, Encrypted Handshake Message"></a>New Session Ticket, Change Cipher Spec, Encrypted Handshake Message</h4><img src="server-finished.png">

<p><code>New Session Ticket</code>服务端建立类似Web应用的session机制，适当时机恢复会话用。</p>
<p><code>Change Cipher Spec</code>通知客户端后续数据使用对称加密算法加密。</p>
<p><code>Encrypted Handshake Message</code>服务端结束握手，发送密文数据给客户端解密，解密通过进行数据传输。</p>
<h3 id="openssl生成证书"><a href="#openssl生成证书" class="headerlink" title="openssl生成证书"></a>openssl生成证书</h3><p>自制CA证书。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成CA证书ca.key</span></span><br><span class="line">$ openssl genrsa -out ca.key 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成根证书签发申请文件ca.csr</span></span><br><span class="line">$ openssl req -new -key ca.key -subj <span class="string">&quot;/CN=fancxxy&quot;</span> -out ca.csr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自签发根证书ca.crt</span></span><br><span class="line">$ openssl x509 -req -<span class="keyword">in</span> ca.csr -signkey ca.key -out ca.crt</span><br></pre></td></tr></table></figure>

<p>生成服务端私钥并签发服务端证书。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成服务端私钥server.key</span></span><br><span class="line">$ openssl genrsa -out server.key 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成服务端公钥server.pem</span></span><br><span class="line"><span class="comment"># $ openssl rsa -in server.key -pubout -out server.pem</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务端申请文件server.csr，/CN设置为localhost方便测试</span></span><br><span class="line">$ openssl req -new -key server.key -subj <span class="string">&quot;/CN=localhost&quot;</span> -out server.csr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 向CA机构申请服务端证书server.crt</span></span><br><span class="line">$ openssl x509 -req -CA ca.crt -CAkey ca.key -CAcreateserial -<span class="keyword">in</span> server.csr -out server.crt</span><br></pre></td></tr></table></figure>

<p>生成客户端私钥并签发客户端证书。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成客户端私钥client.key</span></span><br><span class="line">$ openssl genrsa -out client.key 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># 客户端申请文件client.csr</span></span><br><span class="line">$ openssl req -new -key client.key -subj <span class="string">&quot;/CN=localhost&quot;</span> -out client.csr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 客户端证书client.crt</span></span><br><span class="line">$ openssl x509 -req -CA ca.crt -CAkey ca.key -CAcreateserial -<span class="keyword">in</span> client.csr -out client.crt</span><br></pre></td></tr></table></figure>

<p>目录下文件。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ tree certs</span><br><span class="line">certs</span><br><span class="line">├── ca.crt</span><br><span class="line">├── ca.csr</span><br><span class="line">├── ca.key</span><br><span class="line">├── ca.srl</span><br><span class="line">├── client.crt</span><br><span class="line">├── client.csr</span><br><span class="line">├── client.key</span><br><span class="line">├── server.crt</span><br><span class="line">├── server.csr</span><br><span class="line">└── server.key</span><br><span class="line"></span><br><span class="line">0 directories, 10 files</span><br></pre></td></tr></table></figure>

<h3 id="Go实现HTTPS认证"><a href="#Go实现HTTPS认证" class="headerlink" title="Go实现HTTPS认证"></a>Go实现HTTPS认证</h3><h4 id="单向认证"><a href="#单向认证" class="headerlink" title="单向认证"></a>单向认证</h4><p>服务端使用<code>Server.ListenAndServeTLS</code>方法导入证书和私钥。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	mux := http.NewServeMux()</span><br><span class="line">	mux.HandleFunc(<span class="string">&quot;/ping&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		w.Write([]<span class="type">byte</span>(<span class="string">&quot;pong&quot;</span>))</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	server := &amp;http.Server&#123;</span><br><span class="line">		Addr:    <span class="string">&quot;:443&quot;</span>,</span><br><span class="line">		Handler: mux,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	server.ListenAndServeTLS(<span class="string">&quot;../certs/server.crt&quot;</span>, <span class="string">&quot;../certs/server.key&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端使用<code>x509.NewCertPool</code>创建证书容器，<code>CertPool.AppendCertsFromPEM</code>导入自建CA根证书。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/tls&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/x509&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;golang.org/x/net/http2&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	caCert, err := ioutil.ReadFile(<span class="string">&quot;../certs/ca.crt&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	caPool := x509.NewCertPool()</span><br><span class="line">	caPool.AppendCertsFromPEM(caCert)</span><br><span class="line"></span><br><span class="line">	tlsConfig := &amp;tls.Config&#123;</span><br><span class="line">		RootCAs: caPool,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	client := http.Client&#123;</span><br><span class="line">		Transport: &amp;http2.Transport&#123;</span><br><span class="line">			TLSClientConfig: tlsConfig,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	resp, err := client.Get(os.Args[<span class="number">1</span>])</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line">	bs, err := ioutil.ReadAll(resp.Body)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, bs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动服务端和客户端程序，客户端执行时需要设置环境变量<code> GODEBUG=x509ignoreCN=0</code>。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ GODEBUG=x509ignoreCN=0 go run main.go https://localhost:443/ping</span><br><span class="line">pong</span><br></pre></td></tr></table></figure>

<h4 id="双向认证"><a href="#双向认证" class="headerlink" title="双向认证"></a>双向认证</h4><p>服务端有时候也需要验证客户端身份，客户端身份是CA机构签发，所以服务端需要读取根CA证书。读取方法和单项认证的客户端一样。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/tls&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/x509&quot;</span></span><br><span class="line">	<span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	caCert, err := ioutil.ReadFile(<span class="string">&quot;../certs/ca.crt&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	caPool := x509.NewCertPool()</span><br><span class="line">	caPool.AppendCertsFromPEM(caCert)</span><br><span class="line"></span><br><span class="line">	tlsConfig := &amp;tls.Config&#123;</span><br><span class="line">		ClientCAs:  caPool,</span><br><span class="line">		ClientAuth: tls.RequireAndVerifyClientCert,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mux := http.NewServeMux()</span><br><span class="line">	mux.HandleFunc(<span class="string">&quot;/ping&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		w.Write([]<span class="type">byte</span>(<span class="string">&quot;pong&quot;</span>))</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	server := &amp;http.Server&#123;</span><br><span class="line">		Addr:      <span class="string">&quot;:443&quot;</span>,</span><br><span class="line">		Handler:   mux,</span><br><span class="line">		TLSConfig: tlsConfig,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	server.ListenAndServeTLS(<span class="string">&quot;../certs/server.crt&quot;</span>, <span class="string">&quot;../certs/server.key&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用单项认证的客户端代码直接执行可以看到客户端返回错误<code>tls: bad certificate</code>，服务端返回错误<code>tls: client didn&#39;t provide a certificate</code>。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ GODEBUG=x509ignoreCN=0 go run main.go https://localhost:443/ping</span><br><span class="line">panic: Get <span class="string">&quot;https://localhost:443/ping&quot;</span>: remote error: tls: bad certificate</span><br><span class="line"></span><br><span class="line">goroutine 1 [running]:</span><br><span class="line">main.main()</span><br><span class="line">	/Users/fancxxy/Works/test/http/client/main.go:33 +0x427</span><br><span class="line"><span class="built_in">exit</span> status 2</span><br><span class="line"></span><br><span class="line">$ go run main.go</span><br><span class="line">2020/11/20 16:25:22 http: TLS handshake error from [::1]:49995: tls: client didn<span class="string">&#x27;t provide a certificate</span></span><br></pre></td></tr></table></figure>

<p>客户端提供认证证书，需要<code>tls.LoadX509KeyPair</code>方法加载自己的私钥和公钥并设置到<code>tls.Config</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/tls&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/x509&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	caCert, err := ioutil.ReadFile(<span class="string">&quot;../certs/ca.crt&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	caPool := x509.NewCertPool()</span><br><span class="line">	caPool.AppendCertsFromPEM(caCert)</span><br><span class="line"></span><br><span class="line">	cliCert, err := tls.LoadX509KeyPair(<span class="string">&quot;../certs/client.crt&quot;</span>, <span class="string">&quot;../certs/client.key&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tlsConfig := &amp;tls.Config&#123;</span><br><span class="line">		RootCAs:      caPool,</span><br><span class="line">		Certificates: []tls.Certificate&#123;cliCert&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	client := http.Client&#123;</span><br><span class="line">		Transport: &amp;http.Transport&#123;</span><br><span class="line">			TLSClientConfig: tlsConfig,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	resp, err := client.Get(os.Args[<span class="number">1</span>])</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line">	bs, err := ioutil.ReadAll(resp.Body)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, bs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新直接客户端代码能正确返回结果。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ GODEBUG=x509ignoreCN=0 go run main.go https://localhost:443/ping</span><br><span class="line">pong</span><br></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2022/07/01/bit-operation-add-subtract-multiply-divide/">PREV</a><a class="next" href="/2020/09/09/ICMP/">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'fancxxy';
var disqus_identifier = '2020/11/20/go-https/';
var disqus_title = 'Go实现HTTPS服务器和客户端';
var disqus_url = 'https://fancxxy.github.io/2020/11/20/go-https/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script><div class="copyright"><p>© 2018 - 2022 <a href="https://fancxxy.github.io">fancxxy</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>